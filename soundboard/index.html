<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinkjelly.live</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #e6a4bd;
        }
    </style>
</head>

<body>

    <div class="container mx-auto px-2 py-4">

        <h1 class="text-center mt-4 mb-8 text-4xl text-white uppercase filter drop-shadow">Pinkjelly's soundboard</h1>
        <!--
        <div class="mx-auto text-center">
            <div class="inline-flex items-center">
                <div class="inline-block p-1 rounded-full mr-1 bg-white"><img src="../assets/beans.png" class="h-4 w-4"></div>
                Play on stream with channel points.
            </div>
        </div> -->

        <div style="min-height: 250px;" class="max-w-full mx-auto my-4 flex items-start w-full lg:w-2/3 xl:w-1/2">
            <div class="w-full pt-10">
                <div class="mb-1 flex">
                    <div class="mb-1 flex-grow flex flex-wrap gap-1">
                        <button id="playlist-random-play"
                            class="text-sm shadow rounded bg-white text-black px-2 py-1 hover:bg-blue-500 hover:text-white inline-flex">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                    clip-rule="evenodd" />
                            </svg>
                            Random</button>

                        <button id="playlist-randomise"
                            class="text-sm shadow rounded bg-white text-black px-2 py-1 hover:bg-blue-500 hover:text-white inline-flex">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                                    clip-rule="evenodd" />
                            </svg>
                            Random mashup</button>
                    </div>
                </div>
                <div class="w-full">
                    <div class="flex" style="min-height: 60px;">
                        <div class="flex-grow px-6 py-4 bg-white rounded shadow flex flex-wrap gap-2" id="playlist">

                        </div>
                        <button data-action="playlist-play"
                            class="ml-1 px-4 text-gray-800 rounded bg-white shadow hover:bg-blue-500 hover:text-white flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-xs flex w-full">
                    <div class="flex flex-grow shadow">
                        <div class="bg-gray-700 text-white rounded-l px-2 flex items-center">Direct link</div>
                        <div class="flex-grow">
                            <input type="text" value="" class="rounded-r w-full px-2 py-1" readonly onfocus="this.select()"
                                onclick="this.select()" onmousedown="this.select()" placeholder="Select sounds..."
                                id="playlist-link">
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-1 px-4">
                        <div class="w-8 " style="font-size: 1px;">&nbsp;</div>
                    </div>
                </div>
            </div>

        </div>


        <div class="mt-8">
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-1" id="sounds"></div>
        </div>

        <!-- Templates -->
        <div id="templates" style="display: none;" class="flex flex-col space-y-4 items-start">
            <button id="tpl-sound-tag"
                class="bg-blue-300 font-medium px-2 py-1 inline-flex rounded text-sm select-none items-center" data-action="remove">
                <span class="label">Aaaah</span>
                <div class="ml-1 inline-block text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
            </button>

            <div id="tpl-sound-sample" data-sound-id="1" class="flex space-x-1">
                <div class="bg-white font-medium px-2 py-1 inline-flex rounded text-sm select-none items-center truncate flex-grow">
                    <span class="label">Aaaah</span>
                </div>

                <button data-action="sound-add"
                    class="p-2 text-gray-800 rounded bg-white shadow hover:bg-blue-500 hover:text-white flex items-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                </button>

                <button data-action="sound-play"
                    class="p-2 text-gray-800 rounded bg-white shadow hover:bg-blue-500 hover:text-white flex items-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <script type="application/json" id="sounds-json">
            [
  { "id": 1, "src": "aaah.mp3" },
  { "id": 2, "src": "absolutely-huge.mp3" },
  { "id": 3, "src": "awww.mp3" },
  { "id": 4, "src": "excuse-me.mp3" },
  { "id": 5, "src": "fucked-it.mp3" },
  { "id": 6, "src": "ha-ha.mp3" },
  { "id": 7, "src": "hhhooo.mp3" },
  { "id": 8, "src": "holy-shit.mp3" },
  { "id": 9, "src": "i-am-stressed.mp3" },
  { "id": 10, "src": "i-cant.mp3" },
  { "id": 11, "src": "i-dont-wanna-talk-about-it.mp3" },
  { "id": 12, "src": "i-like-ox.mp3" },
  { "id": 13, "src": "i-touched-his.mp3" },
  { "id": 14, "src": "i-touched-the-man.mp3" },
  { "id": 15, "src": "i-wanna-come.mp3" },
  { "id": 16, "src": "i-will-take-that.mp3" },
  { "id": 17, "src": "i-wouldnt-mind-5-inches.mp3" },
  { "id": 18, "src": "im-feeling-it.mp3" },
  { "id": 19, "src": "it-happened.mp3" },
  { "id": 20, "src": "its-everywhere.mp3" },
  { "id": 21, "src": "its-so-good.mp3" },
  { "id": 22, "src": "its-unexpectedly-thick.mp3" },
  { "id": 23, "src": "just-put-it-in.mp3" },
  { "id": 24, "src": "lets-go.mp3" },
  { "id": 25, "src": "make-it-work.mp3" },
  { "id": 26, "src": "my-controller-is-all-wet-now.mp3" },
  { "id": 27, "src": "nipples.mp3" },
  { "id": 28, "src": "nuts.mp3" },
  { "id": 29, "src": "oh-no.mp3" },
  { "id": 30, "src": "omg-you-guys.mp3" },
  { "id": 31, "src": "omg-you-guys-2.mp3" },
  { "id": 32, "src": "ooo-ill-take-that.mp3" },
  { "id": 33, "src": "ooo-the.mp3" },
  { "id": 34, "src": "oooh-ha-ha-ha.mp3" },
  { "id": 35, "src": "oooh.mp3" },
  { "id": 36, "src": "oooh2.mp3" },
  { "id": 37, "src": "pink.mp3" },
  { "id": 38, "src": "shiiiit.mp3" },
  { "id": 39, "src": "squeal.mp3" },
  { "id": 40, "src": "that-was-a-thick-one.mp3" },
  { "id": 41, "src": "that-was-hard.mp3" },
  { "id": 42, "src": "the-fuck.mp3" },
  { "id": 43, "src": "this-is-what-happens-when-you-get.mp3" },
  { "id": 44, "src": "uhmm.mp3" },
  { "id": 45, "src": "uuhuuh.mp3" },
  { "id": 46, "src": "whaaat.mp3" },
  { "id": 47, "src": "what-do-you-mean.mp3" },
  { "id": 48, "src": "what-is-going-on-right-now.mp3" },
  { "id": 49, "src": "yeah-man.mp3" },
  { "id": 50, "src": "100.mp3" },
  { "id": 51, "src": "69.mp3" },
  { "id": 53, "src": "behind-me.mp3" },
  { "id": 54, "src": "enjoy.mp3" },
  { "id": 55, "src": "gg.mp3" },
  { "id": 56, "src": "i-cant-see-anything.mp3" },
  { "id": 57, "src": "i-dont-know-what-to-say-to-you.mp3" },
  { "id": 58, "src": "i-feel-like.mp3" },
  { "id": 59, "src": "i-must-say.mp3" },
  { "id": 60, "src": "im-jumping-in.mp3" },
  { "id": 61, "src": "im-so-disappointed-in-myself.mp3" },
  { "id": 62, "src": "my-services-are-available-for-hire.mp3" },
  { "id": 63, "src": "nooo.mp3" },
  { "id": 64, "src": "that-flowed-very-nicely.mp3" },
  { "id": 65, "src": "the-perfect-number-doesnt-exist.mp3" },
  { "id": 66, "src": "the-suction.mp3" },
  { "id": 67, "src": "there-is-literally.mp3" },
  { "id": 68, "src": "very-nice-very-nice.mp3" },
  { "id": 69, "src": "well.mp3" },
  { "id": 70, "src": "what-happened.mp3" },
  { "id": 71, "src": "i-wasnt-expecting-that.mp3" },
  { "id": 72, "src": "thats-huge.mp3" },
  { "id": 73, "src": "are-you-in.mp3" },
  { "id": 74, "src": "awww-2.mp3" },
  { "id": 75, "src": "i-apologise.mp3" },
  { "id": 76, "src": "i-dont-know-how-to-feel-about-that-one.mp3" },
  { "id": 77, "src": "i-know-you-just-wanna-you-know.mp3" },
  { "id": 78, "src": "junk.mp3" },
  { "id": 79, "src": "naughty-naughty.mp3" },
  { "id": 80, "src": "no-question-about-it.mp3" },
  { "id": 81, "src": "oh-my.mp3" },
  { "id": 82, "src": "that-would-have-been-so-good.mp3" },
  { "id": 83, "src": "what-is-that.mp3" },
  { "id": 84, "src": "without-a-doubt.mp3" },
  { "id": 85, "src": "everything-hurts.mp3" },
  { "id": 86, "src": "explosive-diarrhea.mp3" },
  { "id": 87, "src": "gimme-a-moment-to-recoup.mp3" },
  { "id": 88, "src": "it-actually-hurts.mp3" },
  { "id": 89, "src": "it-was-easy-to-transition.mp3" },
  { "id": 90, "src": "it-went-for-a-really-long-time.mp3" },
  { "id": 91, "src": "moist.mp3" },
  { "id": 92, "src": "old-me-would-have-done-it.mp3" },
  { "id": 93, "src": "that-was-a-lot.mp3" },
  { "id": 94, "src": "uuuh.mp3" }
]

        </script>
        <script>
            const PLAYLIST_MAX = 10;
            const sounds = JSON.parse(document.getElementById('sounds-json').textContent).sort((s1, s2) => s1.src < s2.src ? -1 : 1);
            const ALL_IDS = sounds.map(s => s.id);
            let playlist = [];

            function getSound(id) {
                return sounds.find(sound => sound.id == id);
            }

            function makeLabel(sound) {
                let labelFromSrc = sound.src.replace(/(^[./]*sounds\/)|(\.[a-z0-9]+$)/g, '').replace(/[_-]/g, ' ');
                labelFromSrc = labelFromSrc.charAt(0).toUpperCase() + labelFromSrc.slice(1);
                return sound.label || labelFromSrc;
            }

            function makeMashup() {
                const n = Math.floor(Math.random() * 4) + 2;
                const indexes = Array.from({ length: n }).reduce((carry) => {
                    let idx;
                    do {
                        idx = Math.floor(Math.random() * sounds.length);
                    } while (carry.includes(idx));
                    return carry.concat(idx);
                }, []);
                return indexes.map(idx => sounds[idx].id);
            }

            function render(root) {
                const tpl = document.getElementById('tpl-sound-sample');

                sounds.forEach(sound => {
                    const node = tpl.cloneNode(true);
                    node.setAttribute('data-sound-id', sound.id);
                    node.querySelector('.label').textContent = makeLabel(sound);
                    root.appendChild(node);
                });

                document.querySelectorAll('[data-action=sound-play]').forEach(node => node.addEventListener('click', e => {
                    const node = e.target;
                    const parent = node.closest('[data-sound-id]');
                    if (!parent) return;
                    playSound(getSound(parent.dataset.soundId));
                }));

                document.querySelectorAll('[data-action=sound-add]').forEach(node => node.addEventListener('click', e => {
                    const node = e.target;
                    const parent = node.closest('[data-sound-id]');
                    if (!parent) return;
                    addToPlaylist(parseInt(parent.dataset.soundId, 10));
                }));
            }

            function registerButtons() {
                document.getElementById('playlist-random-play').addEventListener('click', e => {
                    const sound = sounds[Math.floor(Math.random() * sounds.length)];
                    playlist = [sound.id];
                    renderPlaylist();
                    playPlaylist();
                });

                document.getElementById('playlist-randomise').addEventListener('click', e => {
                    playlist = makeMashup();
                    renderPlaylist();
                });
            }

            function playSound(sound) {
                const audio = new Howl({ src: ['../sounds/' + sound.src] });
                audio.play();
            }

            function playSequence(sounds) {
                if (!sounds.length) {
                    return;
                }
                const howls = sounds.map(s => new Howl({ src: ['../sounds/' + s.src] }));
                howls.forEach((sound, idx) => {
                    if (idx + 1 >= howls.length) return;
                    sound.on('end', () => howls[idx + 1].play())
                });
                howls[0].play();
            }

            function addToPlaylist(id) {
                if (playlist.length >= PLAYLIST_MAX) return;
                if (!ALL_IDS.includes(id)) return;
                playlist.push(id);
                renderPlaylist();
            }

            function ntobin(n, length) {
                return ('0'.repeat(length || 0) + (n.toString(2))).slice(-(length || 0));
            }

            const alphabet = 'abcdefghjkmnpqrstuvwxyz123456789';
            function idsToHash(ids) {
                // Bits are: pjsb (20 bits) + version (2 bits) + ids (7 bits each).
                const header = [12, 8, 15, 1].map(n => ntobin(n, 5)).join('');
                const version = '00';
                const sequence = ids.map(n => ntobin(n, 7)).join('');
                const length = 20 + 2 + sequence.length;
                const padding = length % 5 ? 5 - length % 5 : 0;
                const bits = header + version + sequence + '0'.repeat(padding);
                // Split in 5 characters per each 5 bit.
                return bits.match(/.{5}/g).map(c => alphabet[parseInt(c, 2)]).join('');
            }

            function hashToIds(hash) {
                const bits = hash.split('').map(c => ntobin(alphabet.indexOf(c), 5)).join('');
                if (bits.length % 5 !== 0 || bits.length < 29) return [];
                const ids = bits.slice(22).match(/.{7}/g).map(n => parseInt(n, 2));
                return ids.slice(0, 10).filter(id => ALL_IDS.includes(id));
            }

            function renderPlaylist() {
                const tpl = document.getElementById('tpl-sound-tag');

                const el = document.getElementById('playlist');
                while (el.firstChild) {
                    el.firstChild.remove();
                }

                playlist.forEach((id, idx) => {
                    const sound = getSound(id);
                    if (!sound) return;

                    const node = tpl.cloneNode(true);
                    node.querySelector('.label').textContent = makeLabel(sound);

                    const remove = [node.matches('[data-action=remove]') ? node : null].concat(node.querySelector('[data-action=remove]')).filter(Boolean).forEach(node => {
                        node.addEventListener('click', e => {
                            e.preventDefault();
                            playlist = playlist.slice(0, idx).concat(playlist.slice(idx + 1));
                            renderPlaylist();
                        });
                    });
                    el.appendChild(node);
                });

                document.querySelectorAll('[data-action=playlist-add]').forEach(node => {
                    if (playlist.length >= PLAYLIST_MAX) {
                        node.classList.add('hidden');
                    } else {
                        node.classList.remove('hidden');
                    }
                });

                const rootUrl = location.protocol + '//' + location.host + location.pathname + (location.search ? location.search : "");
                const hash = playlist.length ? idsToHash(playlist) : undefined;
                window.location.hash = hash ? hash : '';
                document.querySelectorAll('#playlist-link').forEach(node => {
                    node.value = hash ? rootUrl + '#' + hash : '';
                });
            }

            function playListInit() {
                document.querySelectorAll('[data-action=playlist-play]').forEach(node =>
                    node.addEventListener('click', e => {
                        e.preventDefault();
                        playPlaylist();
                    }));
                document.querySelectorAll('[data-action=playlist-add]').forEach(node =>
                    node.addEventListener('click', e => {
                        addToPlaylist(parseInt(node.dataset.soundId, 10));
                    }));

                window.addEventListener('hashchange', e => {
                    if (window.location.hash.indexOf('#pjsb') === 0) {
                        playlist = hashToIds(window.location.hash.slice(1));
                        renderPlaylist();
                    }
                });

                if (window.location.hash.indexOf('#pjsb') === 0) {
                    playlist = hashToIds(window.location.hash.slice(1));
                } else {
                    playlist = makeMashup();
                }
            }

            function playPlaylist() {
                const sounds = playlist.map(getSound);
                if (!sounds.length) return;
                playSequence(sounds);
            }

            render(document.getElementById('sounds'));
            playListInit();
            renderPlaylist();
            registerButtons();
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"
            integrity="sha512-6+YN/9o9BWrk6wSfGxQGpt3EUK6XeHi6yeHV+TYD2GR0Sj/cggRpXr1BrAQf0as6XslxomMUxXp2vIl+fv0QRA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</body>

</html>